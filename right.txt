import { endpoints } from "./data.js";
import axios from 'axios';
import { chatContainer, chatRightName, chatFigureImgRight, chatUser, chatContact } from "../UI/domElements.js"

// Obtener los mensajes almacenados en el localStorage
export const getMessagesFromLocalStorage = () => {
  const messagesJson = localStorage.getItem('messages');
  return messagesJson ? JSON.parse(messagesJson) : [];
};

// Generar el HTML del historial de mensajes
const generateConversationHTML = (conversation) => {
  // Código para generar el HTML de la conversación en el lado izquierdo
};

// Generar el HTML de los mensajes en el lado derecho
const generateChatHTML = (conversation) => {
  const { user_1_name, user_1_profile_url, chat } = conversation;
  const lastMessage = chat[chat.length - 1];

  // Actualizar elementos del lado derecho (header)
  chatRightName[0].innerHTML = `<p>${user_1_name}</p>`;
  chatFigureImgRight[0].src = user_1_profile_url;

  // Actualizar elementos del lado derecho (mensajes)
  chatUser[0].innerHTML = `<span>${lastMessage.message}</span><span>${lastMessage.hour}</span>`;
  chatContact[0].innerHTML = `<span>${lastMessage.message}</span><span>${lastMessage.hour}</span>`;
};

// Mostrar todas las conversaciones del lado izquierdo
const displayAllConversations = () => {
  const messages = getMessagesFromLocalStorage();
  chatContainer.innerHTML = '';
  messages.forEach((conversation) => {
    const conversationHTML = generateConversationHTML(conversation);
    chatContainer.innerHTML += conversationHTML;
  });
};

// Función para obtener los mensajes del endpoint y guardarlos en el localStorage
export const fetchMessagesFromEndpoint = async () => {
  try {
    const response = await axios.get(endpoints.urlMessages);
    const messages = response.data;
    saveMessagesToLocalStorage(messages);
    displayAllConversations();

    // Mostrar el primer chat en el lado derecho
    if (messages.length > 0) {
      const firstConversation = messages[0];
      generateChatHTML(firstConversation);
    }

  } catch (error) {
    console.error('Error al obtener los mensajes del endpoint', error);
  }
};

const saveMessagesToLocalStorage = (messages) => {
  localStorage.setItem('messages', JSON.stringify(messages));
};

displayAllConversations();